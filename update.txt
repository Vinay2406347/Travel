import { Component, OnInit } from '@angular/core';
import { InsuranceService } from '../services/insurance.service';
import { Router } from '@angular/router';
import { CommonModule } from '@angular/common';
import { FormsModule } from '@angular/forms';

@Component({
  standalone: true,
  selector: 'app-insurance-selection',
  imports: [CommonModule, FormsModule],
  templateUrl: './insurance-selection.component.html',
  styleUrls: ['./insurance-selection.component.css']
})
export class InsuranceSelectionComponent implements OnInit {
  userId = Number(localStorage.getItem("userId"));
  selected = '';
  plans: any[] = [];
  error = '';
  success = '';

  constructor(private service: InsuranceService, private router: Router) {}

  ngOnInit() {
    this.service.getCoveragePlans().subscribe(data => this.plans = data);
  }

  onSelectionChange() {
    if (this.selected) {
      this.error = '';
    }
  }

  submit() {
    if (!this.selected) {
      this.error = '⚠️ Please select a coverage type.';
      this.success = '';
      return;
    }
  
    this.service.getMyInsurances(this.userId).subscribe(existingInsurances => {
      const alreadyExists = existingInsurances.some(
        insurance => insurance.coverageType === this.selected
      );
  
      if (alreadyExists) {
        this.success = '✅ Insurance already exists for you.';
        this.error = '';
      } else {
        this.service.submitInsurance(this.userId, this.selected).subscribe(() => {
          this.success = '✅ Insurance selected!';
          this.error = '';
          setTimeout(() => this.router.navigate(['/booking']), 2000);
        });
      }
    });
  }
  
}




<div class="container">
  <h2>Select Coverage Type</h2>

  <div class="plans">
    <div class="plan-card" *ngFor="let plan of plans">
      <div class="radio-group">
        <input
          type="radio"
          name="coverage"
          [value]="plan.coverageType"
          [(ngModel)]="selected"
          (change)="onSelectionChange()"
        />
        <label>{{ plan.coverageType }} – ₹{{ plan.price }}</label>
      </div>
      <p class="description">{{ plan.coverageDetails }}</p>
    </div>
  </div>

  <p class="message error" *ngIf="error">{{ error }}</p>
  <p class="message success" *ngIf="success">{{ success }}</p>

  <button (click)="submit()">Submit</button>
</div>
import {Injectable} from '@angular/core';
import { HttpClient } from '@angular/common/http';
import { Observable } from 'rxjs';
@Injectable({ providedIn: 'root' })
export class InsuranceService {
  private baseUrl = 'http://localhost:8080/api'; // Only defined once
 
  constructor(private http: HttpClient) {}
 
  getAssistanceQueries(userId: number): Observable<any[]> {
    return this.http.get<any[]>(`${this.baseUrl}/assistance/user/${userId}`);
  }
 
  addQuery(userId: number, issue: string): Observable<any> {
    return this.http.post(`${this.baseUrl}/assistance`, { userId, issueDescription:issue });
  }  
 
  getMyInsurances(userId: number): Observable<any[]> {
    return this.http.get<any[]>(`${this.baseUrl}/insurance/user/${userId}`);
  }
 
  getCoveragePlans(): Observable<any[]> {
    return this.http.get<any[]>(`${this.baseUrl}/insurance/coverage-plans`);
  }
 
  submitInsurance(userId: number, coverageType: string): Observable<any> {
    return this.http.post(`${this.baseUrl}/insurance`, { userId, coverageType });
  }
}
 


 